async function c(e){let n=new Request("https://token.mail.vorte.app/"),a=caches.default,t=await a.match(n);if(t)return await t.text();let i=await e.MS_OAUTH_CLIENT_SECRET.get(),o=new URLSearchParams({grant_type:"client_credentials",client_id:e.MS_CLIENT_ID,client_secret:i,scope:"https://communication.azure.com/.default"}),l=await fetch(`https://login.microsoftonline.com/${e.AZURE_TENANT_ID}/oauth2/v2.0/token`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:o}),{access_token:s,expires_in:r}=await l.json(),d=Math.max(r-60,0);return t=new Response(s,{headers:{"Cache-Control":`public, max-age=${d}`}}),await a.put(n,t.clone()),s}function p(e,n,a,t){let i=`http://localhost:1001/authn/callback?code=${n}&state=${a}`;return{senderAddress:"DoNotReply@mail.vorte.app",content:{subject:{fi:"Kirjaudu sis\xE4\xE4n yhdell\xE4 klikkauksella",sv:"Logga in med ett klick",en:"Sign in with one click"}[e],plainText:` ${{fi:"K\xE4yt\xE4 alla olevaa linkki\xE4 haluamallasi laitteella kirjautuaksesi Vorten-j\xE4rjestelm\xE4\xE4n ilman salasanaa. Linkki on voimassa 5 minuuttia.",sv:"Anv\xE4nd l\xE4nken nedan f\xF6r att logga in i Vorte utan l\xF6senord. L\xE4nken \xE4r giltig i 5 minuter.",en:"Use the link below to sign in to Vorte without a password. The link is valid for 5 minutes."}[e]} ${i} ${{fi:"Jos et pyyt\xE4nyt kirjautumislinkki\xE4, voit j\xE4tt\xE4\xE4 t\xE4m\xE4n viestin huomiotta.",sv:"Om du inte beg\xE4rde den h\xE4r inloggningsl\xE4nken kan du ignorera det h\xE4r meddelandet.",en:"If you did not request this sign-in link, you can ignore this message."}[e]} ${{fi:"Yst\xE4v\xE4llisin terveisin,",sv:"V\xE4nliga h\xE4lsningar,",en:"Kind regards,"}[e]} ${{fi:"Vorte-tiimi",sv:"Vorte-teamet",en:"The Vorte Team"}[e]} `.trim(),html:` <!DOCTYPE html><html lang="${e}"><head><meta charset="UTF-8"/><style> @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap'); @media screen { body, p, h1, h2, h3, h4, h5, h6, a, span { font-family: 'Poppins', Arial, sans-serif !important; } } body { background: #f4f4f4; margin: 0; padding: 0; } .container { max-width: 600px; margin: 20px auto; background: #ffffff; border-radius: 8px; overflow: hidden; } .header { background: #199473; color: #ffffff; padding: 20px; text-align: center; } .content { padding: 20px; color: #333333; } .button { display: inline-block; background: #0B4F60; color: #ffffff; text-decoration: none; padding: 12px 24px; border-radius: 4px; } .footer { font-size: 12px; color: #666666; padding: 10px; text-align: center; background: #f0f0f0; } a { color: #0B4F60; } </style></head><body><div class="container"><div class="header"><h1>Be your own BOSS</h1></div><div class="content"><p>${{fi:"K\xE4yt\xE4 alla olevaa linkki\xE4 laitteella, jolla haluat kirjautua Vorten-j\xE4rjestelm\xE4\xE4n ilman salasanaa. Linkki on voimassa 5 minuuttia.",sv:"Anv\xE4nd l\xE4nken nedan p\xE5 den enhet du vill logga in i Vorte utan l\xF6senord. L\xE4nken \xE4r giltig i 5 minuter.",en:"Use the link below on the device you want to sign in to Vorte without a password. The link is valid for 5 minutes."}[e]}</p><p style="text-align:center; margin: 30px 0;"><a href="${i}" class="button">${{fi:"Kirjaudu sis\xE4\xE4n",sv:"Logga in",en:"Sign in"}[e]}</a></p><p>${{fi:"Jos nappi ei toimi, kopioi ja liit\xE4 t\xE4m\xE4 URL selaimeesi:",sv:"Om knappen inte fungerar, kopiera och klistra in denna URL i din webbl\xE4sare:",en:"If the button doesn\u2019t work, copy and paste this URL into your browser:"}[e]}</p><p><a href="${i}">${i}</a></p><p>${{fi:"Jos et pyyt\xE4nyt kirjautumislinkki\xE4, voit j\xE4tt\xE4\xE4 t\xE4m\xE4n viestin huomiotta.",sv:"Om du inte beg\xE4rde den h\xE4r inloggningsl\xE4nken kan du ignorera det h\xE4r meddelandet.",en:"If you did not request this sign-in link, you can ignore this message."}[e]}</p><p>${{fi:"Yst\xE4v\xE4llisin terveisin,",sv:"V\xE4nliga h\xE4lsningar,",en:"Kind regards,"}[e]}<br/>${{fi:"Vorte-tiimi",sv:"Vorte-teamet",en:"The Vorte Team"}[e]}</p></div><div class="footer"><p>\xA9 2025 Vorte ERP. Kaikki oikeudet pid\xE4tet\xE4\xE4n.</p></div></div></body></html>`.trim()},recipients:{to:[{address:t}]}}}async function g(e,n,a){let t=e.searchParams.get("code_challenge"),i=e.searchParams.get("state");if(!t||!i)return new Response("Missing code_challenge or state",{status:400});let o=await c(n),l=e.searchParams.get("email"),s=p(a,t,i,l),r=await fetch(`${n.AZURE_COMMUNICATIONS_ENDPOINT}/emails:send?api-version=2023-03-31`,{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify(s)}),d=await r.json();return new Response(JSON.stringify(d,null,2),{status:r.status,headers:{"Content-Type":"application/json"}})}export{g as requestAuthnViaMagicLink};
