function h(t,s){let n="common",o=t.searchParams.get("code_challenge"),a=t.searchParams.get("state");if(!o||!a)return new Response("Missing code_challenge or state",{status:400});let e=new URL(`https://login.microsoftonline.com/${n}/oauth2/v2.0/authorize`);return e.searchParams.set("client_id",s.MS_CLIENT_ID),e.searchParams.set("redirect_uri",s.AUTH_REDIRECT_URI),e.searchParams.set("response_type","code"),e.searchParams.set("response_mode","query"),e.searchParams.set("scope","openid profile email offline_access"),e.searchParams.set("code_challenge",o),e.searchParams.set("code_challenge_method","S256"),e.searchParams.set("state",a),Response.redirect(e.toString(),302)}async function _(t,s,n){let a=`https://login.microsoftonline.com/${t.MS_TENANT_ID||"common"}/oauth2/v2.0/token`,e=await t.MS_OAUTH_CLIENT_SECRET.get(),c=new URLSearchParams({code:n,client_id:t.MS_CLIENT_ID,client_secret:e,redirect_uri:t.AUTH_REDIRECT_URI,grant_type:"authorization_code",code_verifier:s.pkce_verifier}),r=await fetch(a,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:c});if(!r.ok){let i=await r.text();return new Response(`Token exchange failed: ${i}`,{status:502})}return r}export{_ as exchangeTokenWithMs,h as requestAuthnViaMs};
